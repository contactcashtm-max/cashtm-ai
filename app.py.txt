!pip install openai pandas streamlit gspread oauth2client

import streamlit as st
import pandas as pd
from openai import OpenAI
import gspread
from oauth2client.service_account import ServiceAccountCredentials

# ---- OpenAI Key ----
client = OpenAI(api_key="YOUR_API_KEY")

# ---- Google Sheet Load ----
sheet_url = "YOUR_GOOGLE_SHEET_LINK"
df = pd.read_csv(sheet_url.replace("/edit?usp=sharing", "/export?format=csv"))

def fetch_customer(identifier):
    identifier = str(identifier).strip()
    for col in ["Phone", "Aadhaar", "PAN", "Loan Account", "Consumer Name"]:
        if col in df.columns:
            match = df[df[col].astype(str).str.strip() == identifier]
            if not match.empty:
                return match.to_dict(orient="records")[0]
    return None

# ---- Website UI ----
st.title("üìå Cashtm Loan Support AI")

user_id = st.text_input("Enter Phone / Aadhaar / PAN / Loan Account")

if st.button("Fetch Details"):
    customer = fetch_customer(user_id)
    if customer:
        st.success(f"Customer Found: {customer.get('Consumer Name')}")
        st.session_state["customer"] = customer
    else:
        st.error("Customer not found in database")

if "customer" in st.session_state:
    question = st.text_input("Ask your question")

    if st.button("Send"):
        q = question.lower()
        data = st.session_state["customer"]

        # KYC Request
        if any(k in q for k in ["kyc", "aadhaar", "pan", "document"]):
            st.write("""
**KYC Documents Availability**
üì© Email: collection.cashtm@gmail.com  
‚òé Support: 9211220702 / 9211220703 / 9211220704
""")
        # Payment Request
        elif any(k in q for k in ["payment", "pay", "emi", "amount"]):
            st.write("""
**üìå Payment Instructions**
Bank: YES BANK LIMITED  
Account No.: 045626900000381  
IFSC: YESB0000456  
Branch: Chawri Bazaar, New Delhi 110006  
‚òé Confirmation: 09211220703  
""")
        # EMI Offer
        elif any(k in q for k in ["emi", "installment", "installments"]):
            st.write("""
Sir agar aap full payment nahi ‡§ï‡§∞ ‡§™‡§æ‡§§‡•á ‡§π‡•à‡§Ç ‡§§‡•ã ‡§π‡§Æ 11‚Äì12 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•Ä **no cost EMI** ‡§¶‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç  
No hidden charges, no penalty  
Agreement ‡§Æ‡§ø‡§≤‡•á‡§ó‡§æ + legally ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§  
‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è support ‡§®‡§Ç‡§¨‡§∞ ‡§™‡§∞ ‡§¨‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç  
‚òé 9211220702 / 9211220703 / 9211220704
""")
        # After payment confirmation
        elif any(k in q for k in ["update", "noc", "cibil"]):
            st.write("""
Payment ke baad payment proof **collection.cashtm@gmail.com** par ‡§≠‡•á‡§ú ‡§¶‡•á‡§Ç  
2‚Äì3 ‡§ò‡§Ç‡§ü‡•á ‡§Æ‡•á‡§Ç NOC ‡§Æ‡§ø‡§≤ ‡§ú‡§æ‡§è‡§ó‡§æ  
CIBIL **15‚Äì20 ‡§¶‡§ø‡§®** ‡§Æ‡•á‡§Ç update ‡§π‡•ã‡§ó‡§æ  
‡§ú‡§≤‡•ç‡§¶‡•Ä update ‡§ö‡§æ‡§π‡§ø‡§è ‡§§‡•ã CIBIL ‡§™‡§∞ **dispute raise** ‡§ï‡§∞‡•á‡§Ç
""")
        # General AI answer
        else:
            response = client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": "You are NBFC loan support AI assistant."},
                    {"role": "user", "content": str(data) + "\nQuestion: " + question}
                ]
            )
            st.write(response.choices[0].message.content)
